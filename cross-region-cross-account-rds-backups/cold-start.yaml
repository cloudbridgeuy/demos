---
AWSTemplateFormatVersion: "2010-09-09"
Description: "Este Template de CloudFormation contiene los recursos iniciales necesarios para la prueba de concepto."

Parameters:
  DBPassword:
    NoEcho: true
    Description: Password de administración de la base de datos
    Type: String
    MinLength: 8
  DBName:
    Description: Nombre de la base de datos
    Type: String
  DBUser:
    Description: Usuario administrador
    Type: String
  DBSubnetGroupName:
    Description: Nombre del SubnetGroup de la base de datos
    Type: String
  VpcId:
    Description: Id del VPC
    Type: String
  KeyName:
    Description: Nombre de la llave SSH para usar con el bastión
    Type: String
  PublicSubnet:
    Description: Id de la Subnet donde se instalará la base de datos.
    Type: String
  ImageId:
    Description: AMI del servidor bastión
    Type: String

Resources:
  DB:
    Type: "AWS::RDS::DBInstance"
    Properties:
      DBInstanceClass: db.t2.micro
      AllocatedStorage: 20
      DBName: !Ref DBName
      Engine: postgres
      MasterUsername: !Ref DBUser
      MasterUserPassword: !Ref DBPassword
      VPCSecurityGroups:
        - !Ref DBSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroupName
      StorageEncrypted: true
      KmsKeyId: "alias/aws/rds"
      PubliclyAccessible: false

  DBSecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: Permitir acceso a la base de datos desde el servidor bastión
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref BastionSecurityGroup

  BastionSecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: SSH access to bastion host
      VpcId: !Ref VpcId # Replace with your default VPC ID if necessary
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0

  BastionHost:
    Type: "AWS::EC2::Instance"
    Properties:
      InstanceType: t2.micro
      KeyName: !Ref KeyName
      ImageId: !Ref ImageId
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref BastionSecurityGroup

Outputs:
  DBInstanceEndpoint:
    Description: The database endpoint
    Value: !GetAtt DB.Endpoint.Address

  BastionHostPublicIP:
    Description: The public IP address of the bastion host
    Value: !GetAtt BastionHost.PublicIp
